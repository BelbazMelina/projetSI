{% extends 'base.html.twig' %}

{% block title %}Décryptage des formules{% endblock %}

{% block body %}
    <div class="container">
        <h1 class="text-center my-4">Décryptage des formules</h1>

        <div id="game-container" class="text-center">
            <!-- Chronomètre global -->
            <div class="timer mb-4">
                Temps restant : <span id="global-timer">5:00</span>
            </div>

            <!-- Formule chimique -->
            <div id="molecule-container" class="text-center">
                <div class="card mx-auto" style="max-width: 600px;">
                    <div class="card-body">
                        <h2 id="molecule-formula" class="card-title"></h2>
                        <img id="molecule-image" src="" alt="Image de la molécule" class="img-fluid my-3" style="max-width: 300px;">
                        <p id="molecule-info" class="card-text"></p>
                    </div>
                </div>
            </div>

            <!-- Zone de réponse -->
            <div id="answer-zone" class="text-center mt-4">
                <div class="form-group">
                    <label for="final-code" class="mb-2">Entrez le mot secret :</label>
                    <input type="text" id="final-code" class="form-control mx-auto" style="max-width: 200px;" maxlength="100">
                </div>
                <button id="validate-button" class="btn btn-primary mt-3">Valider</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const molecules = {{ molecules|json_encode|raw }};
            const globalTimerElement = document.getElementById('global-timer');
            const moleculeContainer = document.getElementById('molecule-container');
            const moleculeFormula = document.getElementById('molecule-formula');
            const moleculeImage = document.getElementById('molecule-image');
            const moleculeInfo = document.getElementById('molecule-info');
            const validateButton = document.getElementById('validate-button');
            const finalCodeInput = document.getElementById('final-code');

            let globalTimeLeft = 300; // 5 minutes
            let currentMoleculeIndex = 0;

            // Chronomètre global
            const globalTimer = setInterval(() => {
                globalTimeLeft--;
                const minutes = Math.floor(globalTimeLeft / 60);
                const seconds = globalTimeLeft % 60;
                globalTimerElement.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

                if (globalTimeLeft <= 0) {
                    clearInterval(globalTimer);
                    window.location.href = "{{ path('resultat', { success: false }) }}";
                }
            }, 1000);

            // Affichage des molécules
            function showNextMolecule() {
                if (currentMoleculeIndex < molecules.length) {
                    const molecule = molecules[currentMoleculeIndex];
                    moleculeFormula.textContent = molecule.formuleChimique || molecule.formule;
                    if (molecule.image) {
                        moleculeImage.src = `/images/molecules/${molecule.image}`;
                        moleculeImage.style.display = 'block';
                    } else {
                        moleculeImage.style.display = 'none';
                    }
                    moleculeInfo.textContent = molecule.information || '';
                    currentMoleculeIndex++;
                } else {
                    clearInterval(moleculeTimer);
                    moleculeContainer.innerHTML = '<h3>Toutes les molécules ont été affichées</h3>';
                }
            }

            const moleculeTimer = setInterval(showNextMolecule, 5000);
            showNextMolecule(); // Afficher la première molécule immédiatement

            // Validation du mot secret
            validateButton.addEventListener('click', () => {
                const finalCode = finalCodeInput.value.trim().toUpperCase();

                fetch('{{ path('validate_answer') }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': '{{ csrf_token('validate_answer') }}'
                    },
                    body: JSON.stringify({ code: finalCode })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.redirectUrl) {
                            window.location.href = data.redirectUrl;
                        }
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                    });
            });
        });
    </script>
{% endblock %}